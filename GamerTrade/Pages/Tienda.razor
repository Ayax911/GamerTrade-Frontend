@page "/tienda"
@using GamerTrade.Models.DTO
@inject GamerTrade.Services.Interfaces.IJuegoService JuegoService
@inject NavigationManager Navigation
@inject GamerTrade.Services.OrdenadorDeJuegos Ordenador


<div class="tienda-container">
    <!-- Header de la tienda -->
    <div class="tienda-header">
        <h1><i class="bi bi-shop"></i> Tienda de Juegos</h1>
        <div class="carrito-btn-container">
            <button class="btn-carrito" @onclick="IrCarrito">
                <i class="bi bi-cart3"></i>
            </button>
        </div>

        <p class="text-muted">Descubre los mejores juegos para tu colección</p>
    </div>

    <!-- Barra de búsqueda y filtros -->
    <div class="filtros-container">
        <div class="row g-3">
            <!-- Búsqueda -->
            <div class="col-md-5">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text"
                           class="form-control"
                           placeholder="Buscar juegos..."
                           @bind="terminoBusqueda"
                           @bind:event="oninput"
                           @onkeyup="BuscarJuegos" />
                </div>
            </div>

            <!-- Filtro por categoría -->
            <div class="col-md-4">
                <select class="form-select" @onchange="FiltrarPorCategoria">
                    <option value="0">Todas las categorías</option>
                    @foreach (var cat in categorias)
                    {
                        <option value="@cat.CategoriaID">@cat.Nombre</option>
                    }
                </select>
            </div>

            <!-- Ordenar -->
            <div class="col-md-3">
                <select class="form-select" @onchange="OrdenarJuegos">
                    <option value="nombre-asc">A-Z</option>
                    <option value="nombre-desc">Z-A</option>
                    <option value="precio-asc">Precio: Menor a Mayor</option>
                    <option value="precio-desc">Precio: Mayor a Menor</option>
                    <option value="fecha-desc">Más recientes</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando juegos...</p>
        </div>
    }
    else if (!juegosFiltrados.Any())
    {
        <!-- Sin resultados -->
        <div class="text-center py-5">
            <i class="bi bi-inbox fs-1 text-muted"></i>
            <h3 class="mt-3">No se encontraron juegos</h3>
            <p class="text-muted">Intenta con otros filtros de búsqueda</p>
        </div>
    }
    else
    {
        <!-- Grid de juegos -->
        <div class="juegos-grid">
            @foreach (var juego in juegosFiltrados)
            {
                <div class="game-card clickable" @onclick="() => IrADetalle(juego.JuegoID)">
                    <div class="game-image">
                        <img src="@(string.IsNullOrEmpty(juego.UrlImagen) ? $"https://via.placeholder.com/300x200?text={Uri.EscapeDataString(juego.Titulo)}" : juego.UrlImagen)"
                             alt="@juego.Titulo" />
                        @if (juego.Calificacion.HasValue)
                        {
                            <div class="rating-badge">
                                <i class="bi bi-star-fill"></i> @juego.Calificacion.Value.ToString("F1")
                            </div>
                        }
                    </div>

                    <div class="game-content">
                        <h5 class="game-title">@juego.Titulo</h5>
                        <p class="game-version text-muted">@juego.Versión</p>
                        
                        @if (!string.IsNullOrEmpty(juego.CategoriaNombre))
                        {
                            <span class="game-category">
                                <i class="bi bi-tag"></i> @juego.CategoriaNombre
                            </span>
                        }

                        <div class="game-footer">
                            <span class="game-price">$@juego.Precio.ToString("N2")</span>
                            <button class="btn btn-primary btn-sm" 
                                    @onclick="() => AgregarAlCarrito(juego.JuegoID)"
                                    @onclick:stopPropagation="true">
                                <i class="bi bi-cart-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<JuegoDTO> todosLosJuegos = new();
    private List<JuegoDTO> juegosFiltrados = new();
    private List<CategoriaDTO> categorias = new();
    private string terminoBusqueda = string.Empty;
    private int categoriaSeleccionada = 0;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        isLoading = true;

        try
        {
            // Cargar juegos y categorías en paralelo
            var tareaJuegos = JuegoService.ObtenerTodosAsync();
            var tareaCategorias = JuegoService.ObtenerCategoriasAsync();

            await Task.WhenAll(tareaJuegos, tareaCategorias);

            todosLosJuegos = tareaJuegos.Result;
            categorias = tareaCategorias.Result;
            juegosFiltrados = todosLosJuegos;

            Console.WriteLine($"✅ Cargados {todosLosJuegos.Count} juegos y {categorias.Count} categorías");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando datos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task BuscarJuegos()
    {
        if (string.IsNullOrWhiteSpace(terminoBusqueda))
        {
            juegosFiltrados = todosLosJuegos;
        }
        else
        {
            juegosFiltrados = todosLosJuegos.Where(j =>
                j.Titulo.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }

        // Aplicar filtro de categoría si existe
        if (categoriaSeleccionada > 0)
        {
            juegosFiltrados = juegosFiltrados.Where(j => j.CategoriaID == categoriaSeleccionada).ToList();
        }
    }

    private async Task FiltrarPorCategoria(ChangeEventArgs e)
    {
        categoriaSeleccionada = int.Parse(e.Value?.ToString() ?? "0");

        if (categoriaSeleccionada == 0)
        {
            juegosFiltrados = todosLosJuegos;
        }
        else
        {
            juegosFiltrados = todosLosJuegos.Where(j => j.CategoriaID == categoriaSeleccionada).ToList();
        }

        // Aplicar búsqueda si existe
        await BuscarJuegos();
    }

    private async Task OrdenarJuegos(ChangeEventArgs e)
    {
        var ordenamiento = e.Value?.ToString();

        juegosFiltrados = ordenamiento switch
        {
            "nombre-asc" => juegosFiltrados.OrderBy(j => j.Titulo).ToList(),
            "nombre-desc" => juegosFiltrados.OrderByDescending(j => j.Titulo).ToList(),
            "precio-asc" => juegosFiltrados.OrderBy(j => j.Precio).ToList(),
            "precio-desc" => juegosFiltrados.OrderByDescending(j => j.Precio).ToList(),
            "fecha-desc" => juegosFiltrados.OrderByDescending(j => j.Fecha_lanzamiento).ToList(),
            _ => juegosFiltrados
        };
    }

    private void AgregarAlCarrito(int juegoId)
    {
        // TODO: Implementar en Fase 4
        Console.WriteLine($"🛒 Agregar juego {juegoId} al carrito");
        // Por ahora, solo mostrar mensaje
    }

    private void IrADetalle(int juegoId)
    {
        Console.WriteLine($"🎮 Navegando al detalle del juego {juegoId}");
        Navigation.NavigateTo($"/juego/{juegoId}");
    }

    private void IrCarrito()
    {
        Navigation.NavigateTo("/carrito");
    }

    private async Task OrdenarJuegosStrategy(ChangeEventArgs e)
    {
        var ordenamiento = e.Value?.ToString();

        // Seleccionar la estrategia adecuada
        Ordenador.Strategy = ordenamiento switch
        {
            "nombre-asc" => new GamerTrade.Services.Implementaciones.OrdenarPorNombreAsc(),
            "nombre-desc" => new GamerTrade.Services.Implementaciones.OrdenarPorNombreDesc(),
            "precio-asc" => new GamerTrade.Services.Implementaciones.OrdenarPorPrecioAsc(),
            "precio-desc" => new GamerTrade.Services.Implementaciones.OrdenarPorPrecioDesc(),
            
            _ => null
        };

        
        juegosFiltrados = Ordenador.Ejecutar(juegosFiltrados).ToList();

        await Task.CompletedTask;
    }

}


    
