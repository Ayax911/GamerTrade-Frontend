@page "/carrito"
@using GamerTrade.Models.DTO
@using GamerTrade.Services.Interfaces
@inject ICarritoService CarritoService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager Navigation

<div class="carrito-container">

    <!-- Header -->
    <div class="carrito-header">
        <div>
            <h1><i class="bi bi-cart3"></i> Mi Carrito</h1>
            <p class="text-muted">Revisa y confirma tu compra</p>
        </div>

        <button class="btn btn-outline-secondary" @onclick="@(() => Navigation.NavigateTo("/tienda"))">
            <i class="bi bi-arrow-left"></i> Continuar comprando
        </button>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Cargando carrito...</p>
        </div>
    }
    else if (correoUsuario is null)
    {
        <div class="alerta-container alerta-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <div>
                <h4>Debes iniciar sesión</h4>
                <p>Para ver tu carrito, necesitas estar autenticado</p>
            </div>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/login"))">
                <i class="bi bi-box-arrow-in-right"></i> Ir al Login
            </button>
        </div>
    }
    else if (items is null || !items.Any())
    {
        <div class="carrito-vacio">
            <div class="icono-vacio">
                <i class="bi bi-cart-x"></i>
            </div>
            <h3>Tu carrito está vacío</h3>
            <p class="text-muted">Agrega juegos desde la tienda</p>

            <button class="btn btn-primary btn-lg" @onclick="@(() => Navigation.NavigateTo("/tienda"))">
                <i class="bi bi-shop"></i> Ir a la Tienda
            </button>
        </div>
    }
    else
    {
        <!-- Carrito lleno -->
        <div class="carrito-content">

            <!-- Items -->
            <div class="items-section">
                <h2 class="section-title">
                    <i class="bi bi-list-check"></i> Artículos en tu carrito
                </h2>

                <div class="items-grid">

                    @foreach (var item in items)
                    {
                        <div class="item-card">

                            <div class="item-imagen">
                                <img src="@(string.IsNullOrEmpty(item.UrlImagen)
                                                                         ? $"https://via.placeholder.com/150x150?text={Uri.EscapeDataString(item.Titulo ?? "Juego")}"
                                                                         : item.UrlImagen)"
                             alt="@item.Titulo" />

                        @if (item.Calificacion.HasValue)
                                {
                                    <div class="item-rating">
                                        <i class="bi bi-star-fill"></i>
                                        @item.Calificacion.Value.ToString("F1")
                                    </div>
                                }
                            </div>

                            <div class="item-detalles">
                                <h4 class="item-titulo">@item.Titulo</h4>

                                <span class="badge-categoria">
                                    <i class="bi bi-tag"></i> @item.CategoriaNombre
                                </span>
                            </div>

                            <div class="item-precio">
                                <span>Precio</span>
                                <span class="precio-valor">$@item.Precio.ToString("N2")</span>
                            </div>

                            <div class="item-acciones">
                                <button class="btn-eliminar"
                                        disabled="@eliminando"
                                        title="Eliminar"
                                        @onclick="() => EliminarDelCarrito(item.JuegoId)">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>

                        </div>
                    }

                </div>
            </div>

            <!-- Resumen -->
            <div class="resumen-section">

                <div class="resumen-card">
                    <h2 class="section-title"><i class="bi bi-receipt"></i> Resumen</h2>

                    <div class="resumen-detalles">
                        <div class="detalle-fila">
                            <span>Artículos:</span>
                            <span>@items.Count</span>
                        </div>

                        <div class="detalle-fila">
                            <span>Subtotal:</span>
                            <span>$@total.ToString("N2")</span>
                        </div>

                        <div class="detalle-fila">
                            <span>Impuestos (0%):</span>
                            <span>$0.00</span>
                        </div>

                        <div class="detalle-fila">
                            <span>Envío:</span>
                            <span class="texto-verde">Gratis</span>
                        </div>

                        <div class="divider"></div>

                        <div class="detalle-fila total">
                            <span>Total a pagar:</span>
                            <span class="total-valor">$@total.ToString("N2")</span>
                        </div>
                    </div>

                    <button class="btn-comprar" @onclick="ProcederAlCheckout">
                        <i class="bi bi-credit-card"></i> Proceder al Pago
                    </button>

                    <button class="btn-continuar" @onclick="@(() => Navigation.NavigateTo("/tienda"))">
                        <i class="bi bi-arrow-left"></i> Continuar comprando
                    </button>
                </div>

            </div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(mensaje))
    {
        <div class="alerta-container @(mensajeExito ? "alerta-success" : "alerta-error")">
            <i class="bi @(mensajeExito ? "bi-check-circle" : "bi-exclamation-circle")"></i>
            <span>@mensaje</span>

            <button class="btn-cerrar" @onclick="@(() => mensaje = string.Empty)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    }

</div>


@code {
    private List<ItemCarritoDTO>? items;
    private decimal total;
    private string? correoUsuario;
    private bool cargando = true;
    private bool eliminando = false;
    private string? mensaje;
    private bool mensajeExito;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            correoUsuario = await LocalStorage.GetItemAsync<string>("userEmail");

            if (correoUsuario is not null)
                await CargarCarrito();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al inicializar: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CargarCarrito()
    {
        try
        {
            items = await CarritoService.ObtenerItemsCarritoAsync(correoUsuario!);
            total = await CarritoService.ObtenerTotalCarritoAsync(correoUsuario!);
        }
        catch (Exception ex)
        {
            mensaje = "Error al cargar carrito";
            mensajeExito = false;
            Console.WriteLine(ex);
        }
    }

    private async Task EliminarDelCarrito(int juegoId)
    {
        try
        {
            eliminando = true;

            bool ok = await CarritoService.EliminarDelCarritoAsync(correoUsuario!, juegoId);

            if (ok)
            {
                mensaje = "Juego eliminado del carrito";
                mensajeExito = true;

                await CargarCarrito();   // Refrescar
            }
            else
            {
                mensaje = "No se pudo eliminar el juego";
                mensajeExito = false;
            }
        }
        catch
        {
            mensaje = "Error al eliminar";
            mensajeExito = false;
        }
        finally
        {
            eliminando = false;
        }

        await Task.Delay(3000);
        mensaje = string.Empty;
        StateHasChanged();
    }

    private void ProcederAlCheckout()
    {
        if (items is null || items.Count == 0)
        {
            mensaje = "Tu carrito está vacío";
            mensajeExito = false;
            return;
        }

        Navigation.NavigateTo("/checkout");
    }
}
